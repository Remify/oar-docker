
- clean_containers:
  - on_checkpoint: redo
  - on_export_clean:
    - exec_out: echo "Stopping trailing containers"
    - exec_out: touch CONTAINERS_TO_CLEAN
    - exec_out: cat CONTAINERS_TO_CLEAN | xargs -I {} sudo docker kill {}
    - exec_out: echo "Removing trailing containers"
    - exec_out: cat CONTAINERS_TO_CLEAN | xargs -I {} sudo docker rm {}
    - exec_out: rm -f CONTAINERS_TO_CLEAN

- import_rootfs:
  - exec_out: |
      sudo docker images | grep -q $$image \
      || (echo "Importing $$image to docker..." && cat "$$rootfs_archive"\
          | sudo docker import - $$image \
          | xargs -I {} docker tag {} $$image:base)
  - exec_out: sudo docker tag $$image:base $$image:latest

- configure_sshd:
  - on_checkpoint: redo
  - exec_out: echo -e  'y\n' | ssh-keygen -q -t dsa -f $$insecure_ssh_key -N ''
  - exec_out: chmod 600 $$insecure_ssh_key
  - exec_out: echo -e  'Generated private insecure key'
  - exec_out: cat $$insecure_ssh_key
  - exec_out: echo -e  'Generated public insecure key'
  - exec_out: cat $${insecure_ssh_key}.pub
  - exec_out: |
      CID="kameleon_container_$[($RANDOM % ($[50000 - 50] + 1)) + 50]"
      cat $${insecure_ssh_key}.pub | \
        sudo docker run -i -a stdin --dns $$dns --name $CID $$image:latest \
          /bin/bash -c "rm -fr /root/.ssh ;  \
                        mkdir -p /root/.ssh ;  \
                        ssh-keygen -q -t dsa -f /root/.ssh/id_dsa -N '' ; \
                        tee -a /root/.ssh/authorized_keys"
  - on_export_init:
    - exec_in: rm -f /root/.ssh/authorized_keys
  - exec_out: echo "$CID" >> CONTAINERS_TO_CLEAN
  - exec_out: |
      sudo docker images | grep $$image \
                    | grep sshd \
                    | awk '{print $3}' \
                    | xargs -I {} docker rmi {}
  - exec_out: sudo docker commit $CID $$image:sshd > /dev/null
  - exec_out: sudo docker tag $$image:sshd $$image:latest
